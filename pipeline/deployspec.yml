#
# deployspec.yml
#

version: 0.2

env:
  variables:
    terraform_version:                   0.12.21
    wait_time:                           300
    pool_solr_archival_endpoint:         https://pool-solr-ws-archival-dev.internal.lib.virginia.edu
    pool_solr_catalog_endpoint:          https://pool-solr-ws-catalog-dev.internal.lib.virginia.edu
    pool_solr_images_endpoint:           https://pool-solr-ws-images-dev.internal.lib.virginia.edu
    pool_solr_maps_endpoint:             https://pool-solr-ws-maps-dev.internal.lib.virginia.edu
    pool_solr_music_recordings_endpoint: https://pool-solr-ws-music-recordings-dev.internal.lib.virginia.edu
    pool_solr_musical_scores_endpoint:   https://pool-solr-ws-musical-scores-dev.internal.lib.virginia.edu
    pool_solr_serials_endpoint:          https://pool-solr-ws-serials-dev.internal.lib.virginia.edu
    pool_solr_sound_recordings_endpoint: https://pool-solr-ws-sound-recordings-dev.internal.lib.virginia.edu
    pool_solr_thesis_endpoint:           https://pool-solr-ws-thesis-dev.internal.lib.virginia.edu
    pool_solr_video_endpoint:            https://pool-solr-ws-video-dev.internal.lib.virginia.edu

phases:
  install:
    runtime-versions:
      golang: 1.13
    commands:
      - wget https://releases.hashicorp.com/terraform/${terraform_version}/terraform_${terraform_version}_linux_amd64.zip
      - unzip terraform_${terraform_version}_linux_amd64.zip
      - mv terraform /usr/local/bin

  pre_build:
    commands:
      - latest_build=$(aws --region=$AWS_REGION ssm get-parameter --name /containers/$CONTAINER_IMAGE/latest | grep "Value" | awk -F\" '{print $4}')
      - git clone https://$GITLAB_USER:$GITLAB_TOKEN@gitlab.com/uvalib/terraform-infrastructure.git

  build:
    commands:
      - cd $CODEBUILD_SRC_DIR/terraform-infrastructure/virgo4.lib.virginia.edu/ecs-tasks/staging/pool-solr-ws
      - terraform init -no-color
      - terraform apply -no-color -auto-approve -var container_tag=$latest_build
      - sh $CODEBUILD_SRC_DIR/pipeline/wait_for_version.sh $pool_solr_archival_endpoint $latest_build $wait_time
      - sh $CODEBUILD_SRC_DIR/pipeline/wait_for_version.sh $pool_solr_catalog_endpoint $latest_build $wait_time
      - sh $CODEBUILD_SRC_DIR/pipeline/wait_for_version.sh $pool_solr_images_endpoint $latest_build $wait_time
      - sh $CODEBUILD_SRC_DIR/pipeline/wait_for_version.sh $pool_solr_maps_endpoint $latest_build $wait_time
      - sh $CODEBUILD_SRC_DIR/pipeline/wait_for_version.sh $pool_solr_music_recordings_endpoint $latest_build $wait_time
      - sh $CODEBUILD_SRC_DIR/pipeline/wait_for_version.sh $pool_solr_musical_scores_endpoint $latest_build $wait_time
      - sh $CODEBUILD_SRC_DIR/pipeline/wait_for_version.sh $pool_solr_serials_endpoint $latest_build $wait_time
      - sh $CODEBUILD_SRC_DIR/pipeline/wait_for_version.sh $pool_solr_sound_recordings_endpoint $latest_build $wait_time
      - sh $CODEBUILD_SRC_DIR/pipeline/wait_for_version.sh $pool_solr_thesis_endpoint $latest_build $wait_time
      - sh $CODEBUILD_SRC_DIR/pipeline/wait_for_version.sh $pool_solr_video_endpoint $latest_build $wait_time

#  post_build:
#    commands:

#
# end of file
#
